---

- name: Creates Aplication Root
  become: true
  file:
    path: /opt/udapeople/
    state: directory

- name: "Copy build to server"
  become: true
  unarchive:
    src: /root/project/backend/build.zip
    dest: /opt/udapeople

- name: "Start Application"
  become: true
  shell: "pm2 start /opt/udapeople/dist/main.js"
  environment:
    ENVIRONMENT: 'PRODUCTION'
    TYPEORM_CONNECTION: 'POSTGRES'
    TYPEORM_ENTITIES: './src/modules/domain/**/*.entity.ts'
    TYPEORM_HOST: "{{lookup('env', 'TYPEORM_HOST')}}"
    TYPEORM_PORT: 5532
    TYPEORM_USERNAME: "{{lookup('env', 'TYPEORM_USERNAME')}}"
    TYPEORM_PASSWORD: "{{lookup('env', 'TYPEORM_PASSWORD')}}"
    TYPEORM_DATABASE: "{{lookup('env', 'TYPEORM_DATABASE')}}"

